(function(g,a){typeof exports=="object"&&typeof module<"u"?a(exports):typeof define=="function"&&define.amd?define(["exports"],a):(g=typeof globalThis<"u"?globalThis:g||self,a(g.TmUsCommons={}))})(this,function(g){"use strict";var y=Object.defineProperty;var O=(g,a,h)=>a in g?y(g,a,{enumerable:!0,configurable:!0,writable:!0,value:h}):g[a]=h;var i=(g,a,h)=>(O(g,typeof a!="symbol"?a+"":a,h),h);class a{constructor(t){i(this,"name","ROOT");t!=null&&(this.name=t)}debug(t,...e){this.print(console.debug,"DEBUG",t,...e)}info(t,...e){this.print(console.info,"INFO",t,...e)}trace(t,...e){this.print(console.trace,"TRACE",t,...e)}warn(t,...e){this.print(console.warn,"WARN",t,...e)}error(t,...e){this.print(console.error,"ERROR",t,...e)}print(t,e,s,...n){let l=`${new Date().toJSON()} [${e}] [${this.name}] ${s} `;n!=null&&n.length>0?t(l,...n):t(l)}}class h{constructor(t=!1){i(this,"logger");i(this,"useLocalStorage");this.logger=new a("config"),this.useLocalStorage=t}listValues(){if(this.useLocalStorage){let e=[];for(let s=0;s<localStorage.length;s++){let n=localStorage.key(s);n!=null&&e.push(n)}return e}let t=GM_listValues();return this.logger.debug("获取所有配置项名称: ",t),t}getValue(t,e){if(this.useLocalStorage){let n=localStorage.getItem(t);return n==null?e:JSON.parse(n)}let s=GM_getValue(t,e);return this.logger.debug("获取配置项%s，结果: ",t,s),s}setValue(t,e){if(this.useLocalStorage){let s=JSON.stringify(e);localStorage.setItem(t,s);return}this.logger.debug("设置配置项%s设置为: ",t,e),GM_setValue(t,e)}initValueIfNotExists(t,e){let s=this.getValue(t,null);s==null?(this.logger.debug("配置项%s不存在，初始化为: ",t,e),this.setValue(t,e)):this.logger.debug("配置项%s已存在，值为: ",t,s)}deleteValue(t){if(this.useLocalStorage){localStorage.removeItem(t);return}this.logger.debug("删除配置项%s",t),GM_deleteValue(t)}listValuesAsync(){return GM.listValues()}getValueAsync(t,e){return GM.getValue(t,e)}setValueAsync(t,e){return GM.setValue(t,e)}deleteValueAsync(t){return GM.deleteValue(t)}}class w{constructor(t,e=3e3,s=!0){i(this,"logger",new a("websocket-client"));i(this,"url","ws://127.0.0.1:8080/websocket");i(this,"connectTimeout");i(this,"connected");i(this,"webSocket");this.url=t,this.connectTimeout=e,this.connected=!1,s&&this.createWebSocket()}createWebSocket(){this.logger.info("正在创建WebSocket");let t=new WebSocket(this.url);this.addWebSocketListeners(t),this.logger.info("WebSocket创建成功：",t),this.webSocket=t}addWebSocketListeners(t){this.logger.info("正在绑定WebSocket事件监听");let e=this;t.onopen=s=>{e.connected=!0,e.onOpen(s)},this.logger.debug("open事件绑定完成"),t.onmessage=s=>{e.onMessage(s)},this.logger.debug("message事件绑定完成"),t.onclose=s=>{e.connected=!1,e.onClose(s)},this.logger.debug("close事件绑定完成"),t.onerror=s=>{e.connected=!1,e.onError(s)},this.logger.debug("error事件绑定完成")}send(t){return this.webSocket==null?(this.logger.error("WebSocket未创建"),!1):this.connected?(this.webSocket.send(t),!0):(this.logger.error("未连接到WebSocket服务端"),!1)}waitForOpen(){let t=this;return new Promise((e,s)=>{let n=new Date().valueOf(),r=setInterval(()=>{let l=new Date().valueOf()-n;if(l>=this.connectTimeout){clearInterval(r),s(`WebSocket服务端${t.url}连接超时`);return}t.connected&&(clearInterval(r),e(l))},1)})}onOpen(t){this.logger.info("websocket服务端连接成功: ",t)}onMessage(t){this.logger.info("处理服务端发送报文事件: ",t)}onClose(t){this.logger.info("与websocket服务端连接断开: ",t)}onError(t){this.logger.info("websocket通信发生错误: ",t)}}class v{constructor(t,e,s){i(this,"jsonrpc");i(this,"method");i(this,"params");i(this,"id");this.jsonrpc="2.0",this.method=t,this.params=e,this.id=s}}class S extends w{constructor(e,s="number",n=5e3,r=1){super(e);i(this,"msgIdType");i(this,"seq");i(this,"timeout");i(this,"interval");i(this,"requests");i(this,"responses");this.msgIdType=s,this.timeout=n,this.interval=r,this.seq=new Uint32Array(1),this.seq[0]=0,this.requests=new Map,this.responses=new Map}generateMsgId(){return this.msgIdType=="string"?crypto.randomUUID():Atomics.add(this.seq,0,1)}createRequestAndSend(e,s,n){n==null&&(n=this.generateMsgId());let r=new v(e,s,n);this.sendRequest(r)}sendRequest(e){if(e.id==null){this.logger.warn("无效的JSON-RPC请求报文，缺少id字段: ",e);return}let s=JSON.stringify(e);this.requests.set(e.id,e),super.send(s)}onMessage(e){let s=JSON.parse(e.data);if(s==null){this.logger.warn(`接收到来自${e.origin}的报文，无法转换为JSON对象：${e.data}`);return}if(s.jsonrpc==null){this.logger.warn("报文中未找到jsonrpc字段");return}if(s.jsonrpc!="2.0"){this.logger.warn("JSON-RPC版本不为2.0");return}if(s.method!=null){this.handleRequest(s);return}if(s.id!=null){this.handleResponse(s);return}this.logger.warn("接收到无法处理的报文：",s)}handleRequest(e){this.logger.debug("接收到请求报文：",e)}handleResponse(e){this.logger.debug("接收到响应报文：",e),this.responses.set(e.id,e)}waitForResponse(e,s,n){let r=new Date().valueOf(),l=setInterval(()=>{let o=new Date().valueOf()-r;if(o>=this.timeout){clearInterval(l),this.logger.error("获取响应报文超时"),s("获取响应报文超时");return}if(this.responses.has(e)){clearInterval(l);let u=this.responses.get(e);if(u!=null&&u.result!=null){this.logger.debug(`获取到请求${e}的响应报文，耗时${o}ms`),n(u);return}this.logger.error("抽取响应报文失败: ",u),s("抽取响应报文失败")}},this.interval)}}let I={url:"ws://127.0.0.1:6800/jsonrpc",msgIdType:"number",token:null,timeout:3e4,interval:10};class j extends S{constructor(e){let s={...I,...e};super(s.url,s.msgIdType,s.timeout,s.interval);i(this,"token");this.token=s.token}getSecret(){return this.token!=null&&this.token.trim()!=""?`token:${this.token}`:null}reconnect(e,s){e!=null&&(this.url=e),s!=null&&(this.token=s),this.createWebSocket()}generateParams(){let e=[],s=this.getSecret();return s!=null&&e.push(s),e}getVersion(){let e="aria2.getVersion",s=this.generateParams(),n=this.generateMsgId();this.createRequestAndSend(e,s,n);let r=this;return new Promise((l,o)=>{r.waitForResponse(n,o,u=>{let c=u.result;l(c)})})}addUri(e,s={},n){let r="aria2.addUri",l=this.generateParams();l.push(e),s!=null&&l.push(s),n!=null&&l.push(n);let o=this.generateMsgId();this.createRequestAndSend(r,l,o);let u=this;return new Promise((c,f)=>{u.waitForResponse(o,f,p=>{let V=p.result.gid;c(V)})})}tellStatus(e,s=["gid","status","totalLength","completedLength"]){let n="aria2.tellStatus",r=this.generateParams();r.push(e),s!=null&&r.push(s);let l=this.generateMsgId();this.createRequestAndSend(n,r);let o=this;return new Promise((u,c)=>{o.waitForResponse(l,c,f=>{let p=f.result;u(p)})})}}class m{constructor(t,e,s){i(this,"logger");i(this,"cdn","https://cdn.jsdelivr.net/npm/");i(this,"timeout",5e3);i(this,"checkInterval",1);this.logger=new a("dynamic-injector"),t!=null&&(this.cdn=t),e!=null&&(this.timeout=e),s!=null&&(this.checkInterval=s)}getExtName(t){let e=new URL(t),s=e.pathname.lastIndexOf(".");return e.pathname.substring(s)}injectByUrl(t,e,s){let n=this.getExtName(t);if(n==".js"){let r=document.createElement("script");r.type="application/javascript",r.src=t,document.body.appendChild(r),this.logger.info(`开始注入js: ${t}`)}else if(n==".css"){let r=document.createElement("link");r.rel="stylesheet",r.href=t,document.head.appendChild(r),this.logger.info(`开始注入css: ${t}`)}else this.logger.info(`无法注入元素的文件类型: ${n}`);return new Promise((r,l)=>{if(s==null)return;let o=new Date().valueOf(),u=setInterval(()=>{let c=new Date().valueOf()-o;if(c>=e){clearInterval(u),l(`${t}加载超时`);return}let f=s(c);if(f!=null){clearInterval(u),r(f);return}},this.checkInterval)})}injectFromCDN(t,e,s,n,r,l){let o=`${t}${e}@${s}${n}`;return this.injectByUrl(o,r,l)}inject(t,e,s,n){return this.injectFromCDN(this.cdn,t,e,s,this.timeout,n)}}let b={mountPointId:"app",html:null,styles:"",vueVersion:"3.2",elementVersion:"2.3",vueOptions:{},provides:{},plugins:[]};class k{constructor(t){i(this,"logger");i(this,"injector");i(this,"options");this.logger=new a("vue-app-loader"),this.injector=new m,this.options={...b,...t}}async load(t){let e=t!=null?{...b,...t}:this.options,s=document.createElement("div");e.html!=null&&e.html.trim().length>0?s.outerHTML=e.html.trim():s.id=e.mountPointId,document.body.appendChild(s),e.styles!=null&&GM_addStyle(e.styles);do{if(e.vueVersion==null)break;let n=await this.injector.inject("vue",e.vueVersion,"/dist/vue.global.js",o=>{if(typeof Vue<"u"){let u=Vue;return this.logger.info(`Vue ${u.version} 加载完成，耗时 ${o} ms`),u}return null});if(n==null||e.elementVersion==null)break;let r=await this.injector.inject("element-plus",e.elementVersion,"/dist/index.full.js",o=>{if(typeof ElementPlus<"u"){let u=ElementPlus;return this.logger.info(`Element Plus ${u.version} 加载完成，耗时 ${o} ms`),u}return null});this.injector.inject("element-plus",e.elementVersion,"/dist/index.css");let l=n.createApp(e.vueOptions);r!=null&&(l.use(r),l.provide("$message",r.ElMessage));for(let o of e.plugins)l.use(o);for(let o in e.provides)if(o.startsWith("$")){let u=e.provides[o];this.logger.info("正在注入provide：%s = ",o,u),l.provide(o,u)}return l.mount(`#${e.mountPointId}`),l}while(!1)}}g.Aria2Client=j,g.Config=h,g.DynamicInjector=m,g.Logger=a,g.VueAppLoader=k,Object.defineProperty(g,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=commons.umd.js.map
